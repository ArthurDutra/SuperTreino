<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Treino App</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg: #121212; --card: #1f1f23; --text: #ffffff; 
            --primary: #c084fc; --secondary: #fb923c; --accent: #facc15;
            --success: #4ade80; --danger: #ef4444; --edit-mode: #facc15;
            --spotify: #1DB954;
            --bronze: #cd7f32; --silver: #c0c0c0; --gold: #ffd700;
            
            --color-1: #38bdf8; --color-2: #f472b6; --color-3: #a78bfa;
            --color-4: #fb923c; --color-5: #22d3ee; --color-6: #4ade80;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 0; padding-bottom: 50px; overscroll-behavior: none;
        }
        
        .screen { display: none; padding: 20px; animation: fadeIn 0.3s; min-height: 100vh; flex-direction: column; position: relative; }
        .visible { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .empty-msg { text-align: center; color: #888; margin-top: 40px; font-style: italic; font-size: 14px; font-weight: 400; }

        /* HEADER */
        .header-bar { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 25px; position: sticky; top: 0; 
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(10px);
            z-index: 50; padding: 15px 0; border-bottom: 1px solid #333; 
        }
        .app-title { font-size: 22px; font-weight: 800; color: var(--text); letter-spacing: 0.5px; display: flex; align-items: center; text-transform: uppercase; font-style: italic; }
        .user-title { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .header-actions { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; font-size: 24px; cursor: pointer; color: #fff; padding: 0; transition: transform 0.2s; }
        .btn-icon:active { transform: scale(0.9); }
        .icon-active { color: var(--edit-mode); transform: scale(1.1); text-shadow: 0 0 10px var(--edit-mode); }

        /* LISTAS & CARDS */
        #user-list, #workout-select-list { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 10px; }
        .card-wrapper { position: relative; width: 100%; max-width: 400px; }

        .btn-large { 
            width: 100%; padding: 22px 25px; border: none; border-radius: 18px; 
            font-size: 18px; font-weight: 700; cursor: pointer; color: #fff; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); text-transform: uppercase;
            text-align: left; display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.1s; font-family: 'Poppins', sans-serif;
        }
        .btn-large:active { transform: scale(0.98); }
        
        .edit-input { 
            background: rgba(255,255,255,0.1); border: 1px solid #555; color: #fff; 
            padding: 10px; border-radius: 8px; font-family: inherit; font-size: inherit; 
            width: 100%; box-sizing: border-box; font-weight: bold; margin-bottom: 5px;
        }
        .edit-input:focus { border-color: var(--accent); outline: none; }
        .edit-input-inline { width: 50px; text-align: center; margin: 0 2px; background: #333; border: none; display: inline-block; }

        .workout-select-card {
            background: var(--card); border: 1px solid #333; color: #fff;
            padding: 25px; border-radius: 20px; cursor: pointer;
            width: 100%; text-align: left; position: relative; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .workout-select-card h3 { margin: 0 0 5px 0; font-size: 20px; overflow-wrap: break-word; }
        .workout-select-card p { margin: 0; color: #888; font-size: 14px; font-weight: 400; }
        .workout-select-card:active { transform: scale(0.98); background: #25252a; }

        /* EXERC√çCIOS */
        .workout-container { padding-bottom: 120px; }
        .exercise-card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 15px; border-left: 6px solid #555; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .exercise-header { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 15px; }
        .chk-container { position: relative; display: flex; align-items: center; min-width: 32px; }
        input[type="checkbox"] { width: 32px; height: 32px; cursor: pointer; opacity: 0; position: absolute; z-index: 2; }
        .custom-chk { width: 32px; height: 32px; background: #2a2a2a; border-radius: 10px; display: inline-block; position: relative; pointer-events: none; transition: 0.3s; border: 2px solid #444; }
        input:checked + .custom-chk { background: var(--success); border-color: var(--success); transform: scale(1.1); }
        input:checked + .custom-chk::after { content: '‚úî'; color: #000; position: absolute; left: 7px; top: 1px; font-weight: 800; font-size: 20px; }
        
        .ex-info { flex-grow: 1; min-width: 0; }
        .ex-name { font-size: 18px; font-weight: 600; display: block; margin-bottom: 6px; color: #fff; word-wrap: break-word; }
        .ex-meta { display: flex; gap: 10px; align-items: center; font-size: 14px; color: #bbb; font-weight: 500; flex-wrap: wrap; }
        .badge { background: #333; padding: 4px 12px; border-radius: 8px; font-weight: 700; font-size: 12px; color: #fff; }
        .btn-video { color: var(--secondary); text-decoration: none; font-weight: 800; border: 2px solid var(--secondary); padding: 2px 10px; border-radius: 8px; font-size: 10px; text-transform: uppercase; transition: 0.2s; }
        
        .weight-control { margin-top: 15px; background: #151515; padding: 10px; border-radius: 14px; display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px solid #333; }
        .weight-label { color: #666; font-size: 11px; margin-right: auto; padding-left: 5px; font-weight: 700; letter-spacing: 1px; }
        .btn-weight { width: 42px; height: 42px; background: #333; border: none; border-radius: 12px; color: #fff; font-size: 24px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-weight:active { background: var(--primary); transform: scale(0.9); }
        .weight-display { flex-grow: 1; text-align: center; font-size: 20px; font-weight: 800; color: var(--primary); font-family: 'Poppins', monospace; cursor: pointer; }
        .no-load { color: #666; font-size: 12px; font-family: 'Poppins', sans-serif; letter-spacing: 1px; text-transform: uppercase; }

        /* EDI√á√ÉO */
        .edit-controls-floating { position: absolute; right: -10px; top: -10px; display: flex; flex-direction: column; gap: 8px; z-index: 10; animation: popIn 0.2s; pointer-events: none; opacity: 0; transition: 0.2s; }
        .editing .edit-controls-floating { opacity: 1; pointer-events: auto; }
        .btn-float { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #fff; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.5); color: #fff; font-size: 14px; transition: transform 0.2s; }
        .btn-float:active { transform: scale(0.9); }
        .btn-del { background: var(--danger); }
        .btn-reorder { background: var(--secondary); border-color: #fff; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        .btn-add-item { display: none; } 
        .editing .btn-add-item { display: block; width: 100%; max-width: 400px; padding: 20px; background: rgba(250, 204, 21, 0.1); border: 2px dashed var(--edit-mode); color: var(--edit-mode); border-radius: 16px; cursor: pointer; font-size: 16px; font-weight: 800; margin-top: 15px; text-align: center; }
        .editing .btn-large, .editing .workout-select-card, .editing .exercise-card { border: 1px dashed #555; opacity: 0.8; }
        .editing .card-wrapper > button, .editing .workout-select-card, .editing .exercise-card { pointer-events: none; }
        .editing .edit-input, .editing .edit-controls-floating, .editing .weight-display, .editing .btn-video { pointer-events: auto; }

        .footer-fixed { position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px; background: linear-gradient(to top, var(--bg) 80%, transparent); display: flex; justify-content: center; z-index: 90; pointer-events: none; }
        .btn-finish { width: 100%; max-width: 400px; padding: 20px; background: var(--success); color: #000; font-weight: 900; border: none; border-radius: 50px; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 5px 25px rgba(74, 222, 128, 0.4); cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; pointer-events: auto; transition: transform 0.2s; }
        .btn-finish:active { transform: scale(0.98); }
        .btn-finish:disabled { background: #333; color: #555; box-shadow: none; cursor: default; }

        /* Bot√£o Sair (Tela Inicial) */
        .btn-exit { margin-top: 20px; background: #333; color: #888; font-size: 12px; padding: 10px 20px; border-radius: 20px; border: 1px solid #444; }

        /* MODAIS PERSONALIZADOS (DI√ÅLOGO) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; text-align: center; backdrop-filter: blur(5px); }
        .msg-content { background: #1a1a1a; padding: 30px; border-radius: 25px; border: 2px solid var(--primary); max-width: 400px; width: 100%; box-shadow: 0 0 30px rgba(192, 132, 252, 0.2); }
        .msg-title { font-weight: 800; font-size: 22px; color: var(--text); margin-bottom: 15px; }
        .msg-text { color: #ccc; margin-bottom: 25px; font-style: italic; line-height: 1.5; font-size: 16px; }
        .msg-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-dialog { padding: 12px 20px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; flex-grow: 1; text-transform: uppercase; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: #333; color: #fff; }

        /* Bot√£o Spotify */
        .btn-spotify { width: 100%; padding: 12px; margin-bottom: 15px; background: #191414; border: 2px solid var(--spotify); border-radius: 50px; color: var(--spotify); font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        
        /* MEDALHAS */
        .game-header { text-align: center; margin-bottom: 30px; }
        .total-days-badge { background: linear-gradient(45deg, var(--primary), var(--secondary)); padding: 10px 20px; border-radius: 50px; font-weight: 800; font-size: 20px; box-shadow: 0 0 20px rgba(192, 132, 252, 0.4); display: inline-block; }
        .medal-shelf { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .medal-box { background: var(--card); border: 1px solid #333; border-radius: 15px; padding: 15px; text-align: center; position: relative; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .medal-unlocked { opacity: 1; filter: grayscale(0); border-color: var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }
        .medal-icon { font-size: 40px; margin-bottom: 5px; display: block; }
        .medal-title { font-size: 12px; font-weight: 700; color: #fff; text-transform: uppercase; display: block; }
        .medal-desc { font-size: 10px; color: #888; display: block; margin-top: 5px; }
        .medal-progress { font-size: 10px; color: var(--accent); font-weight: bold; margin-top: 5px; display: block; }

        #db-status { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #555; z-index: 200; font-weight: bold; }
        .status-online { color: var(--success) !important; }

        .theme-1 { background: linear-gradient(135deg, #005f73, #0ea5e9); } .bd-theme-1 { border-left-color: #0ea5e9; }
        .theme-2 { background: linear-gradient(135deg, #831843, #ec4899); } .bd-theme-2 { border-left-color: #ec4899; }
        .theme-3 { background: linear-gradient(135deg, #4c1d95, #8b5cf6); } .bd-theme-3 { border-left-color: #8b5cf6; }
        .theme-4 { background: linear-gradient(135deg, #7c2d12, #f97316); } .bd-theme-4 { border-left-color: #f97316; }
        .theme-5 { background: linear-gradient(135deg, #134e4a, #14b8a6); } .bd-theme-5 { border-left-color: #14b8a6; }
        .theme-6 { background: linear-gradient(135deg, #14532d, #22c55e); } .bd-theme-6 { border-left-color: #22c55e; }
    </style>
</head>
<body>

    <div id="db-status">‚ö™ Offline</div>

    <div id="screen-menu" class="screen visible">
        <div class="header-bar">
            <div class="app-title"><span class="app-logo">‚ö°</span> SUPERTREINO</div>
            <div class="header-actions">
                <button class="btn-icon" onclick="window.app.showHistory()" title="Hist√≥rico">üìã</button>
                <button class="btn-icon" id="btn-edit-menu" onclick="window.app.toggleMenuEdit()" title="Editar">‚úèÔ∏è</button>
            </div>
        </div>
        <div id="user-list"></div>
        <button id="btn-add-user" class="btn-add-item" onclick="window.app.addUser()">+ NOVA PESSOA</button>
        <center><button class="btn-exit" onclick="window.close()">Sair do App</button></center>
    </div>

    <div id="screen-workout-select" class="screen">
        <div class="header-bar">
            <button class="btn-icon" onclick="window.history.back()">‚¨ÖÔ∏è</button>
            <span class="user-title" id="select-user-title">...</span>
            <button class="btn-icon" id="btn-edit-select" onclick="window.app.toggleSelectEditMode()" title="Editar">‚úèÔ∏è</button>
        </div>
        <div id="workout-select-list"></div>
        <button id="btn-add-workout" class="btn-add-item" onclick="window.app.addWorkout()">+ NOVO TREINO</button>
    </div>

    <div id="screen-active-workout" class="screen">
        <div class="header-bar">
            <button class="btn-icon" onclick="window.history.back()">‚¨ÖÔ∏è</button>
            <span class="user-title" id="active-title">Treino A</span>
            <div class="header-actions">
                <button class="btn-icon" onclick="window.open('https://open.spotify.com', '_blank')" title="Spotify">üéß</button>
                <button class="btn-icon" id="btn-edit-active" onclick="window.app.toggleActiveEditMode()" title="Editar">‚úèÔ∏è</button>
            </div>
        </div>
        <div id="active-workout-container" class="workout-container"></div>
        <button id="btn-add-exercise" class="btn-add-item" onclick="window.app.addExercise()" style="margin-bottom: 80px;">+ NOVO EXERC√çCIO</button>
        <div class="footer-fixed">
            <button id="btn-finish-main" class="btn-finish" onclick="window.app.finishWorkout()">üèÅ Finalizar</button>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <div class="header-bar">
            <button class="btn-icon" onclick="window.history.back()">‚¨ÖÔ∏è</button>
            <span class="user-title">Hist√≥rico</span>
            <button class="btn-icon" onclick="window.app.openGamification()" title="Conquistas">üèÜ</button>
        </div>
        <div id="history-list"></div>
    </div>

    <div id="screen-gamification" class="screen">
        <div class="header-bar">
            <button class="btn-icon" onclick="window.history.back()">‚¨ÖÔ∏è</button>
            <span class="user-title" style="color:var(--accent)">Conquistas</span>
            <div style="width:40px"></div>
        </div>
        <div class="game-header">
            <div class="total-days-badge">üî• <span id="total-days-count">0</span> DIAS DE TREINO</div>
        </div>
        <h3 style="margin-left:10px; color:#888; font-size:12px;">SEMANA ATUAL</h3>
        <div class="medal-shelf">
            <div class="medal-box" id="medal-week-3"><span class="medal-icon">ü•â</span><span class="medal-title">Bronze</span><span class="medal-desc">3 dias</span><span class="medal-progress" id="prog-week-3">0/3</span></div>
            <div class="medal-box" id="medal-week-4"><span class="medal-icon">ü•à</span><span class="medal-title">Prata</span><span class="medal-desc">4 dias</span><span class="medal-progress" id="prog-week-4">0/4</span></div>
            <div class="medal-box" id="medal-week-5"><span class="medal-icon">ü•á</span><span class="medal-title">Ouro</span><span class="medal-desc">5 dias</span><span class="medal-progress" id="prog-week-5">0/5</span></div>
        </div>
        <h3 style="margin-left:10px; color:#888; font-size:12px;">M√äS ATUAL (SEMANAS)</h3>
        <div class="medal-shelf">
            <div class="medal-box" id="medal-month-2"><span class="medal-icon">ü•â</span><span class="medal-title">Bronze</span><span class="medal-desc">2 sem.</span><span class="medal-progress" id="prog-month-2">0/2</span></div>
            <div class="medal-box" id="medal-month-3"><span class="medal-icon">ü•à</span><span class="medal-title">Prata</span><span class="medal-desc">3 sem.</span><span class="medal-progress" id="prog-month-3">0/3</span></div>
            <div class="medal-box" id="medal-month-4"><span class="medal-icon">ü•á</span><span class="medal-title">Ouro</span><span class="medal-desc">4 sem.</span><span class="medal-progress" id="prog-month-4">0/4</span></div>
        </div>
        <h3 style="margin-left:10px; color:#888; font-size:12px;">ANO ATUAL (MESES)</h3>
        <div class="medal-shelf">
            <div class="medal-box" id="medal-year-8"><span class="medal-icon">ü•â</span><span class="medal-title">Bronze</span><span class="medal-desc">8 meses</span><span class="medal-progress" id="prog-year-8">0/8</span></div>
            <div class="medal-box" id="medal-year-9"><span class="medal-icon">ü•à</span><span class="medal-title">Prata</span><span class="medal-desc">9 meses</span><span class="medal-progress" id="prog-year-9">0/9</span></div>
            <div class="medal-box" id="medal-year-10"><span class="medal-icon">ü•á</span><span class="medal-title">Ouro</span><span class="medal-desc">10 meses</span><span class="medal-progress" id="prog-year-10">0/10</span></div>
        </div>
    </div>

    <div id="custom-modal" class="modal-overlay">
        <div class="msg-content">
            <div class="msg-title" id="d-title">T√çTULO</div>
            <div class="msg-text" id="d-msg">Mensagem</div>
            <div class="msg-actions" id="d-actions"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXpjF-2oGF3RrfqT9KjthB4NVZXUGtsCg",
            authDomain: "supertreino-e20ee.firebaseapp.com",
            databaseURL: "https://supertreino-e20ee-default-rtdb.firebaseio.com",
            projectId: "supertreino-e20ee",
            storageBucket: "supertreino-e20ee.firebasestorage.app",
            messagingSenderId: "1092691038600",
            appId: "1:1092691038600:web:3402f46bbbc304a466ea3d"
        };

        let db;
        async function startFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth();
                await signInAnonymously(auth);
                db = getDatabase(app);
                document.getElementById('db-status').innerText = "üü¢ Online";
                document.getElementById('db-status').classList.add('status-online');
                window.dbRef = ref; window.dbSet = set; window.dbOnValue = onValue;
                window.dbPush = push; window.dbRemove = remove; window.dbInstance = db;
                if(window.app) window.app.init();
            } catch(e) { console.error("Erro Conex√£o:", e); if(window.app) window.app.init(); }
        }
        startFirebase();
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js', {scope: '/SuperTreino/'}); });
      }
    </script>

    <script>
    const successMessages = ["T√° pago! Agora pode chorar no banho.", "A dor √© tempor√°ria, a gl√≥ria √© eterna.", "Suor √© gordura chorando!", "Treino feito! Finja que consegue andar.", "Mais um dia vencido. O sof√° te espera.", "Voc√™ treina para comer sem culpa!", "Shape de respeito em constru√ß√£o.", "Parab√©ns! Voc√™ √© melhor que quem n√£o veio.", "Zero dias sem reclamar, mas zero sem treinar!", "Diz a lenda que depois da dor vem o m√∫sculo.", "A meta √© ficar irreconhec√≠vel.", "Foco, for√ßa e f√©!", "N√£o pare quando doer, pare quando acabar.", "Frango n√£o tem vez aqui!", "Quem tem pena √© galinha!", "Seu √∫nico limite √© a sua mente.", "Shape se constr√≥i com cara feia.", "Sorria, voc√™ ficou mais forte.", "Descanse, mas n√£o desista.", "Hoje voc√™ venceu a pregui√ßa.", "Treinar √© vida. O resto √© intervalo.", "Calma, respira e agacha!", "Se n√£o for para suar, nem saio de casa.", "Ficar monstro √© obriga√ß√£o.", "Ven√ßa a si mesmo todos os dias.", "Disciplina √© liberdade.", "O √∫nico treino ruim √© o que n√£o aconteceu.", "Transforme dor em poder.", "Fa√ßa os dias contarem.", "Seu corpo pode tudo.", "Voc√™ aguenta mais uma!", "Levanta esse peso!", "Sem dor, sem ganho.", "Todo campe√£o j√° foi um frango.", "O sucesso come√ßa fora da zona de conforto.", "N√£o deseje que fosse f√°cil.", "Fa√ßa por voc√™.", "O esfor√ßo de hoje √© o orgulho de amanh√£.", "Treino bom √© treino que descabela.", "Se n√£o pode voar, corra.", "Muscula√ß√£o: levantar coisas pesadas.", "Se consegue ler isso sem tremer, treinou errado.", "Academia: meu playground.", "Menos mimimi, mais agachamento.", "N√£o espere incentivo, o shape √© seu.", "V√° treinar!", "Corpo s√£o, mente s√£, perna doendo.", "A vida come√ßa depois do treino.", "Seus m√∫sculos n√£o sabem contar.", "Supere seus limites.", "N√£o √© sobre tempo, √© prioridade.", "Desculpas n√£o queimam calorias.", "Treino conclu√≠do com √≥dio e sucesso.", "Amanh√£ voc√™ vai agradecer.", "Se est√° f√°cil, aumenta o peso.", "Foco no objetivo.", "Voc√™ n√£o chegou at√© aqui pra parar.", "Seja sua motiva√ß√£o.", "Dor muscular √© trof√©u.", "Treinar cura tudo.", "O imposs√≠vel √© s√≥ quest√£o de opini√£o.", "Seja sua melhor vers√£o.", "N√£o tenha medo de falhar.", "Cada gota de suor conta.", "Respeite o processo.", "Construindo um corpo blindado.", "Treino √© terapia.", "N√£o diminua a meta.", "Vencedores treinam.", "Hoje t√° pago com juros.", "Se quer algo novo, fa√ßa algo novo.", "A dor de hoje √© for√ßa.", "N√£o pare at√© se orgulhar.", "Voc√™ √© seu advers√°rio.", "Levanta a cabe√ßa e o peso.", "Firme igual rocha.", "Treino de hoje: Sobreviver.", "Ame o processo.", "Fim de treino! Coma prote√≠na.", "Sentindo as pernas? N√£o. Valeu? Sim.", "Falha muscular √© vida.", "Aprenda a descansar.", "Vai doer? Vai.", "Treino de perna se lamenta.", "O corpo ideal tem algu√©m feliz dentro.", "Hospital da alma.", "Seu corpo ouve sua mente.", "Fa√ßa seu 'eu' do futuro feliz.", "N√£o √© sorte, √© suor.", "Const√¢ncia √© a chave.", "Esmaga que cresce!", "Bora ficar gigante!", "Shape inexplic√°vel.", "Treino de gente grande.", "Sai da frente que t√¥ passando!", "Hoje o treino rendeu.", "Miss√£o dada √© miss√£o cumprida.", "Nada vence o trabalho duro.", "O topo √© logo ali.", "Monstro saindo da jaula!", "Foco total.", "Sem massagem!", "Dale!", "Brabo demais!"];
    const quitMessages = ["J√° vai? O sof√° te chamou?", "Fugindo do leg day?", "Sua m√£e disse que voc√™ podia sair?", "Volta aqui, frango!", "Ei, o treino n√£o acabou!", "Desistir √© para os fracos.", "Voc√™ prometeu que ia treinar!", "A porta da rua √© serventia da vergonha.", "Vai deixar o peso ganhar?", "N√£o ouse sair agora!", "O cron√¥metro t√° te julgando.", "Vai chorar no banho ou terminar?", "Se sair agora, vira estat√≠stica.", "Quem foge n√£o cresce.", "T√° com medinho?", "Volta pro treino, soldado!", "Sair agora = Frango pra sempre.", "Acha que o shape vem por osmose?", "N√£o me decepcione.", "Voc√™ √© melhor que isso.", "Onde voc√™ pensa que vai?", "Fica! Vai ter bolo (mentira).", "Se sair, o treino n√£o conta.", "Honre seu suor.", "Termina isso logo!", "Pregui√ßa n√£o define car√°ter.", "Vai sair sem terminar? Que feio.", "O peso t√° leve, volta l√°.", "N√£o seja um desistente.", "Falta pouco, aguenta!", "A dor passa, a vergonha fica.", "Voc√™ n√£o √© de a√ß√∫car.", "Vai derreter se continuar?", "Sair agora √© derrota.", "Mostre do que √© feito.", "N√£o clique nesse bot√£o!", "Bloqueado por falta de vergonha.", "Volte e termine o servi√ßo.", "Sua av√≥ treinaria mais que isso.", "T√° doendo? Que bom.", "Sem desculpas.", "Vai sair de fininho?", "Eu vi voc√™ clicando em voltar!", "O treino n√£o √© opcional.", "Compromisso √© tudo.", "N√£o traia seu corpo.", "Se sair, paga 10 flex√µes.", "Vai correr da raia?", "N√£o seja essa pessoa.", "Termina e a gente conversa.", "Fuga das galinhas?", "Voc√™ consegue, volta l√°.", "N√£o desperdice o tempo.", "Foco!", "Disciplina!", "Cad√™ a for√ßa de vontade?", "Vai se arrepender se sair.", "O espelho n√£o mente.", "N√£o saia!", "Volta!", "Fica!", "Treina!", "Esmaga!", "N√£o foge!", "Voc√™ √© guerreiro ou v√≠tima?", "Encare o desafio.", "N√£o tem atalho.", "Se sair, o shape murcha.", "Cancele a sa√≠da, n√£o o treino.", "Persist√™ncia √© tudo.", "N√£o seja med√≠ocre.", "Supere a vontade de ir embora.", "O resultado vem pra quem fica.", "N√£o desista.", "Lute contra a pregui√ßa.", "Seja forte.", "Aguenta firme.", "T√° acabando (quase).", "N√£o me irrite.", "Volta pro supino.", "N√£o abandone os pesos.", "Eles sentem sua falta.", "Se sair, zero whey hoje.", "Voc√™ aguenta.", "Confio em voc√™.", "Bora!", "N√£o para!", "Continua!", "Mais um pouco!", "Vai valer a pena!", "N√£o saia da tela.", "Mantenha o foco.", "Olho no objetivo.", "Se sair, engorda 1kg.", "Brincadeira (ou n√£o).", "Fica a√≠.", "Treino s√©rio.", "Sem corpo mole.", "Bora monstro!", "Vence isso!"];
    const incompleteMessages = ["Roubando repeti√ß√£o? Que feio.", "Vai deixar exerc√≠cio pra amanh√£?", "Treino pela metade, resultado pela metade.", "Acha que eu n√£o vi essa caixa vazia?", "Assim voc√™ n√£o fica monstro.", "T√° esquecendo coisa pra tr√°s!", "Volta l√° e marca tudo.", "N√£o adianta mentir pro app.", "Seu b√≠ceps t√° chorando.", "Finalizar assim? S√©rio?", "Voc√™ consegue fazer tudo!", "N√£o seja pregui√ßoso.", "Faltou um ali, √≥.", "O treino √© completo ou n√£o √©.", "Quem rouba no treino, rouba na vida.", "T√° com pressa de que?", "Termina o servi√ßo.", "N√£o fa√ßa servi√ßo de porco.", "Seja honesto com seu treino.", "Vai deixar buraco no treino?", "Isso n√£o √© um treino completo.", "Falta exerc√≠cio!", "Olha as caixinhas vazias.", "Preenche tudo!", "N√£o me engana.", "O shape n√£o vem pela metade.", "Vai ficar devendo?", "Paga o que deve!", "N√£o finalizo se n√£o terminar.", "Volta e faz direito.", "T√° achando que √© festa?", "Treino s√©rio exige tudo.", "N√£o pule o leg day.", "Nem o supino.", "Completa isso a√≠.", "Estou de olho.", "N√£o valida treino fofo.", "Quer resultado? Fa√ßa tudo.", "Sem atalhos.", "O caminho √© completo.", "N√£o deixe nada pra tr√°s.", "Zere o treino.", "Marque todas as op√ß√µes.", "Falta pouco, n√£o desista.", "Fa√ßa valer a pena.", "N√£o seja meio termo.", "Tudo ou nada.", "100% ou 0%.", "Vai sair devendo?", "O app sabe que faltou.", "N√£o mente pra mim.", "Seu corpo sabe.", "Termina!", "Faz tudo!", "N√£o enrola.", "Sem migu√©.", "Que vergonha...", "Pensei que fosse monstro.", "Cad√™ a disciplina?", "Falta um check.", "Ou dois.", "Ou tr√™s.", "T√° quase, n√£o para.", "Finalizar incompleto √© pecado.", "O deus do ferro t√° vendo.", "N√£o decepcione o Arnold.", "Fa√ßa por merecer.", "Conquiste o bot√£o finalizar.", "Ele s√≥ libera se fizer tudo.", "Bloqueado por pregui√ßa.", "Volte e treine.", "N√£o tem essa de pular.", "Cada exerc√≠cio conta.", "N√£o desperdice.", "Valorize seu tempo.", "Fa√ßa bem feito.", "Qualidade total.", "N√£o aceito meio treino.", "Sou exigente.", "Voc√™ tamb√©m deveria ser.", "Bora marcar tudo.", "Tica tudo!", "Checklist incompleto.", "Erro 404: Exerc√≠cio n√£o encontrado.", "Corrija isso.", "Agora sim (se fizer).", "Vai logo!", "Quero ver tudo verde.", "Sem caixas vazias.", "Preenchimento obrigat√≥rio.", "Treino √© sagrado.", "Am√©m?", "Bora terminar!"];

    window.app = {
        data: {}, historyData: [], currentUser: null, currentWorkoutIndex: null, isTraining: false,
        isMenuEditing: false, isSelectEditing: false, isActiveEditing: false,

        init: function() {
            if (!history.state) history.replaceState({ screen: 'screen-menu' }, '');
            
            // Loop Fuj√£o & Block Back Button
            window.onpopstate = (event) => {
                if (this.isTraining) {
                    // Impede o "voltar" real empurrando o estado de novo
                    history.pushState({ screen: 'screen-active-workout', userId: this.currentUser, wIndex: this.currentWorkoutIndex }, '');
                    
                    const randomMsg = quitMessages[Math.floor(Math.random() * quitMessages.length)];
                    this.showCustomModal(
                        'danger',
                        `üö® ${randomMsg}\n\nO treino est√° rolando. Sair cancela o tempo. Deseja realmente sair?`,
                        () => {
                            this.isTraining = false;
                            window.onbeforeunload = null;
                            localStorage.removeItem('tempWorkoutState'); 
                            // Navega√ß√£o for√ßada para fora
                            this.navigate('screen-workout-select');
                        }
                    );
                } else {
                    if (event.state) this.restoreScreen(event.state);
                    else this.toggleScreen('screen-menu'); 
                }
            };

            if (window.dbInstance) {
                window.dbOnValue(window.dbRef(window.dbInstance, 'users'), (snap) => {
                    this.data = snap.val() || {}; 
                    this.refreshCurrentScreen();
                });
                window.dbOnValue(window.dbRef(window.dbInstance, 'history'), (snap) => {
                    const val = snap.val();
                    const allHist = val ? Object.keys(val).map(k => ({...val[k], firebaseId: k})).sort((a,b) => b.id - a.id) : [];
                    // Filtro Individual
                    this.historyData = this.currentUser ? allHist.filter(h => h.user === this.data[this.currentUser]?.name) : [];
                    
                    if(document.getElementById('screen-history').classList.contains('visible')) this.renderHistoryList();
                    if(document.getElementById('screen-gamification').classList.contains('visible')) this.updateMedalsUI();
                });
            } else {
                this.data = JSON.parse(localStorage.getItem('gymData_v51')) || {};
                const allHist = JSON.parse(localStorage.getItem('gymHistory')) || [];
                // Filtro Individual Local
                this.historyData = this.currentUser ? allHist.filter(h => h.user === this.data[this.currentUser]?.name) : [];
                this.refreshCurrentScreen();
            }
        },

        save: function() { 
            if(window.dbInstance) window.dbSet(window.dbRef(window.dbInstance, 'users'), this.data);
            else localStorage.setItem('gymData_v51', JSON.stringify(this.data)); 
        },

        handleBack: function() { window.history.back(); },

        navigate: function(screenId, stateData = {}) {
            const newState = { screen: screenId, ...stateData };
            history.pushState(newState, '');
            this.restoreScreen(newState);
        },

        restoreScreen: function(state) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('visible'));
            document.getElementById(state.screen).classList.add('visible');
            window.scrollTo(0,0);

            if (state.screen === 'screen-menu') { this.currentUser = null; this.renderMenu(); }
            else if (state.screen === 'screen-workout-select') { this.currentUser = state.userId; this.renderWorkoutSelectScreen(); }
            else if (state.screen === 'screen-active-workout') { this.currentUser = state.userId; this.currentWorkoutIndex = state.wIndex; this.renderActiveWorkout(); }
            else if (state.screen === 'screen-history') { this.renderHistoryList(); }
            else if (state.screen === 'screen-gamification') { this.updateMedalsUI(); }
        },

        refreshCurrentScreen: function() {
            const current = document.querySelector('.screen.visible').id;
            if (current === 'screen-menu') this.renderMenu();
            if (current === 'screen-workout-select') this.renderWorkoutSelectScreen();
            if (current === 'screen-active-workout') this.renderActiveWorkout();
            if (current === 'screen-gamification') this.updateMedalsUI();
        },

        // --- SISTEMA DE DI√ÅLOGO UNIFICADO ---
        showCustomModal: function(type, msg, confirmCallback) {
            const modal = document.getElementById('custom-modal');
            const title = document.getElementById('d-title');
            const text = document.getElementById('d-msg');
            const actions = document.getElementById('d-actions');

            text.innerText = msg;
            actions.innerHTML = ''; // Limpa bot√µes

            if (type === 'success') {
                modal.querySelector('.msg-content').style.borderColor = 'var(--success)';
                title.innerText = "PARAB√âNS!";
                title.style.color = 'var(--success)';
                const btn = document.createElement('button');
                btn.className = 'btn-dialog btn-primary';
                btn.innerText = "FECHAR";
                btn.onclick = () => { modal.style.display = 'none'; confirmCallback(); };
                actions.appendChild(btn);
            } else if (type === 'warning') {
                modal.querySelector('.msg-content').style.borderColor = 'var(--accent)';
                title.innerText = "ATEN√á√ÉO";
                title.style.color = 'var(--accent)';
                const btnYes = document.createElement('button');
                btnYes.className = 'btn-dialog btn-primary';
                btnYes.innerText = "SIM, FINALIZAR";
                btnYes.onclick = () => { modal.style.display = 'none'; confirmCallback(); };
                const btnNo = document.createElement('button');
                btnNo.className = 'btn-dialog btn-secondary';
                btnNo.innerText = "CANCELAR";
                btnNo.onclick = () => { modal.style.display = 'none'; };
                actions.appendChild(btnNo);
                actions.appendChild(btnYes);
            } else { // danger (Fuj√£o)
                modal.querySelector('.msg-content').style.borderColor = 'var(--danger)';
                title.innerText = "FUJ√ÉO?";
                title.style.color = 'var(--danger)';
                const btnYes = document.createElement('button');
                btnYes.className = 'btn-dialog btn-primary';
                btnYes.innerText = "SIM, SAIR";
                btnYes.style.background = 'var(--danger)';
                btnYes.onclick = () => { modal.style.display = 'none'; confirmCallback(); };
                const btnNo = document.createElement('button');
                btnNo.className = 'btn-dialog btn-secondary';
                btnNo.innerText = "FICAR";
                btnNo.onclick = () => { modal.style.display = 'none'; };
                actions.appendChild(btnNo);
                actions.appendChild(btnYes);
            }
            modal.style.display = 'flex';
        },

        // --- MEDALHAS ---
        openGamification: function() {
            // Recarrega o hist√≥rico espec√≠fico do usu√°rio atual antes de mostrar
             if (window.dbInstance) {
                // J√° atualizado pelo listener
             } else {
                 const allHist = JSON.parse(localStorage.getItem('gymHistory')) || [];
                 this.historyData = allHist.filter(h => h.user === this.data[this.currentUser]?.name);
             }
            this.navigate('screen-gamification');
            this.updateMedalsUI();
        },

        updateMedalsUI: function() {
            if(!this.historyData) return;
            const uniqueDates = new Set();
            this.historyData.forEach(h => {
                const parts = h.date.split('/'); // DD/MM/YYYY
                uniqueDates.add(`${parts[2]}-${parts[1]}-${parts[0]}`); // ISO
            });
            const sortedDates = Array.from(uniqueDates).sort();
            document.getElementById('total-days-count').innerText = sortedDates.length;

            const now = new Date();
            const currentWeekNum = this.getWeekNumber(now);
            const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
            const currentYearKey = now.getFullYear();

            let daysInThisWeek = 0;
            const weeksInMonth = {};
            const monthsInYear = {};

            sortedDates.forEach(dateStr => {
                const [y, m, d] = dateStr.split('-').map(Number);
                const dateObj = new Date(y, m-1, d);
                const weekNum = this.getWeekNumber(dateObj);
                const monthKey = `${y}-${m-1}`;
                const yearKey = y;

                if (y === now.getFullYear() && weekNum === currentWeekNum) daysInThisWeek++;
                if (!weeksInMonth[monthKey]) weeksInMonth[monthKey] = new Set();
                weeksInMonth[monthKey].add(weekNum);
                if (!monthsInYear[yearKey]) monthsInYear[yearKey] = new Set();
                monthsInYear[yearKey].add(m-1);
            });

            this.setMedalState('week-3', daysInThisWeek, 3);
            this.setMedalState('week-4', daysInThisWeek, 4);
            this.setMedalState('week-5', daysInThisWeek, 5);

            const weeksDoneThisMonth = weeksInMonth[currentMonthKey] ? weeksInMonth[currentMonthKey].size : 0;
            this.setMedalState('month-2', weeksDoneThisMonth, 2);
            this.setMedalState('month-3', weeksDoneThisMonth, 3);
            this.setMedalState('month-4', weeksDoneThisMonth, 4);

            const monthsDoneThisYear = monthsInYear[currentYearKey] ? monthsInYear[currentYearKey].size : 0;
            this.setMedalState('year-8', monthsDoneThisYear, 8);
            this.setMedalState('year-9', monthsDoneThisYear, 9);
            this.setMedalState('year-10', monthsDoneThisYear, 10);
        },

        setMedalState: function(id, current, target) {
            const el = document.getElementById(`medal-${id}`);
            const prog = document.getElementById(`prog-${id}`);
            const isUnlocked = current >= target;
            prog.innerText = `${Math.min(current, target)}/${target}`;
            if (isUnlocked) { el.classList.add('medal-unlocked'); prog.style.color = '#fff'; } 
            else { el.classList.remove('medal-unlocked'); prog.style.color = 'var(--accent)'; }
        },

        getWeekNumber: function(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        },

        renderMenu: function() {
            const list = document.getElementById('user-list'); list.innerHTML = '';
            const userKeys = Object.keys(this.data);
            if (userKeys.length === 0) list.innerHTML = '<p class="empty-msg">Nenhum usu√°rio encontrado.<br>Toque na caneta ‚úèÔ∏è e no + para come√ßar.</p>';
            
            userKeys.forEach((id, idx) => {
                const u = this.data[id];
                const wrap = document.createElement('div'); wrap.className = 'card-wrapper';
                let content = `<span>${u.name}</span> <span style="font-size:14px">‚ûú</span>`;
                if(this.isMenuEditing) {
                    content = `<input type="text" class="edit-input" value="${u.name}" onclick="event.stopPropagation()" onchange="window.app.renameUser('${id}', this.value)">`;
                }
                const btn = document.createElement('button'); btn.className = `btn-large ${u.themeId}`;
                btn.innerHTML = content;
                btn.onclick = () => this.navigate('screen-workout-select', { userId: id });
                if(this.isMenuEditing) {
                    const ctrl = document.createElement('div'); ctrl.className = 'edit-controls-floating';
                    ctrl.innerHTML = `<div class="btn-float btn-del" onclick="window.app.deleteUser(event, '${id}')">X</div>
                        ${idx > 0 ? `<div class="btn-float btn-reorder" onclick="window.app.reorderUser('${id}', -1)">‚¨ÜÔ∏è</div>` : ''}
                        ${idx < userKeys.length - 1 ? `<div class="btn-float btn-reorder" onclick="window.app.reorderUser('${id}', 1)">‚¨áÔ∏è</div>` : ''}`;
                    wrap.appendChild(ctrl);
                }
                wrap.appendChild(btn); list.appendChild(wrap);
            });
            this.updateEditIcon('btn-edit-menu', 'screen-menu', this.isMenuEditing);
        },
        
        renderWorkoutSelectScreen: function() {
            if(!this.currentUser || !this.data[this.currentUser]) return;
            const u = this.data[this.currentUser];
            document.getElementById('select-user-title').innerText = u.name;
            const list = document.getElementById('workout-select-list'); list.innerHTML = '';
            if(!u.workouts || u.workouts.length === 0) {
                list.innerHTML = `<p class="empty-msg">Nenhum treino cadastrado.<br>Toque na caneta ‚úèÔ∏è para criar.</p>`;
                if(!u.workouts) u.workouts = [];
            }
            u.workouts.forEach((w, idx) => {
                const wrap = document.createElement('div'); wrap.className = 'card-wrapper';
                const card = document.createElement('div');
                card.className = `workout-select-card bd-${u.themeId}`;
                card.style.borderLeft = '5px solid';
                card.onclick = () => this.navigate('screen-active-workout', { userId: this.currentUser, wIndex: idx });
                let titleDisplay = `<h3>${w.title}</h3>`;
                if(this.isSelectEditing) {
                    const parts = w.title.split(' - ');
                    const prefix = parts.length > 1 ? parts[0] + ' - ' : '';
                    const name = parts.length > 1 ? parts.slice(1).join(' - ') : w.title;
                    titleDisplay = `<h3>${prefix}<input type="text" class="edit-input" style="width:100%; display:block; margin-top:5px" value="${name}" onclick="event.stopPropagation()" onchange="window.app.renameWorkout(${idx}, '${prefix}', this.value)"></h3>`;
                }
                card.innerHTML = `${titleDisplay}<p>${w.exercises ? w.exercises.length : 0} exerc√≠cios</p>`;
                if(this.isSelectEditing) {
                    const ctrl = document.createElement('div'); ctrl.className = 'edit-controls-floating';
                    ctrl.innerHTML = `<div class="btn-float btn-del" onclick="window.app.deleteWorkout(event, ${idx})">X</div>`;
                    wrap.appendChild(ctrl);
                }
                wrap.appendChild(card); list.appendChild(wrap);
            });
            this.updateEditIcon('btn-edit-select', 'screen-workout-select', this.isSelectEditing);
        },

        renderActiveWorkout: function() {
            if(!this.currentUser || this.currentWorkoutIndex === null) return;
            const u = this.data[this.currentUser];
            if (!u.workouts) return;
            const w = u.workouts[this.currentWorkoutIndex];
            if (!w) return;

            const hasExercises = w.exercises && w.exercises.length > 0;
            if (!this.isTraining && hasExercises) {
                this.isTraining = true;
                window.onbeforeunload = function() { return "Treino rodando."; };
            }

            // RECUPERA ESTADO
            const savedState = JSON.parse(localStorage.getItem('tempWorkoutState')) || {};
            const myState = (savedState.u === this.currentUser && savedState.w === this.currentWorkoutIndex) ? savedState.c : [];

            const cont = document.getElementById('active-workout-container');
            document.getElementById('active-title').innerText = w.title;
            document.getElementById('active-title').className = `user-title txt-${u.themeId}`;
            cont.innerHTML = '';
            const btnFinish = document.getElementById('btn-finish-main');

            if (!hasExercises) {
                w.exercises = [];
                cont.innerHTML = '<p class="empty-msg">Este treino est√° vazio.<br>Toque na caneta ‚úèÔ∏è para adicionar.</p>';
                btnFinish.disabled = true; btnFinish.innerText = "Adicione exerc√≠cios";
                this.isTraining = false; 
            } else {
                btnFinish.disabled = false; btnFinish.innerText = "üèÅ Finalizar";
            }

            w.exercises.forEach((ex, i) => {
                const vid = `https://www.youtube.com/results?search_query=execu√ß√£o+${encodeURIComponent(ex.name)}`;
                const div = document.createElement('div'); div.className = `exercise-card bd-${u.themeId}`;
                const weightVal = parseInt(ex.weight) || 0;
                const weightText = weightVal === 0 ? '<span class="no-load">SEM CARGA</span>' : `${weightVal} KG`;
                const isChecked = myState[i] ? 'checked' : ''; 

                let exInfo = `<span class="ex-name">${ex.name}</span><div class="ex-meta"><span class="badge">${ex.sets}x${ex.reps}</span> <a href="${vid}" target="_blank" class="btn-video">üé•</a></div>`;
                if(this.isActiveEditing) {
                    exInfo = `<input type="text" class="edit-input" value="${ex.name}" style="margin-bottom:5px" onchange="window.app.renameEx(${i}, this.value)">
                        <div class="ex-meta"><input type="text" class="edit-input edit-input-inline" value="${ex.sets}" onchange="window.app.updateExMeta(${i}, 'sets', this.value)"> x 
                        <input type="text" class="edit-input edit-input-inline" value="${ex.reps}" onchange="window.app.updateExMeta(${i}, 'reps', this.value)"></div>`;
                }

                div.innerHTML = `
                    <div class="exercise-header">
                        <div class="chk-container"><input type="checkbox" class="ex-check" data-index="${i}" onchange="window.app.autoSaveState()" ${isChecked}><span class="custom-chk"></span></div>
                        <div class="ex-info">${exInfo}</div>
                        ${this.isActiveEditing ? `<div class="edit-controls-floating" style="top:-5px; right:-5px;"><div class="btn-float btn-del" onclick="window.app.deleteEx(${i})">X</div><div class="btn-float btn-reorder" onclick="window.app.reorderEx(${i}, -1)">‚¨ÜÔ∏è</div><div class="btn-float btn-reorder" onclick="window.app.reorderEx(${i}, 1)">‚¨áÔ∏è</div></div>` : ''}
                    </div>
                    <div class="weight-control">
                        <span class="weight-label">CARGA</span>
                        <button class="btn-weight" onclick="window.app.chgWeight(${i}, -1)">-</button>
                        <div class="weight-display" onclick="window.app.promptWeight(${i})">${weightText}</div>
                        <button class="btn-weight" onclick="window.app.chgWeight(${i}, 1)">+</button>
                    </div>`;
                cont.appendChild(div);
            });
            this.updateEditIcon('btn-edit-active', 'screen-active-workout', this.isActiveEditing);
        },

        autoSaveState: function() {
            const chks = document.querySelectorAll('.ex-check');
            const states = [];
            chks.forEach(c => states.push(c.checked));
            const saveObj = { u: this.currentUser, w: this.currentWorkoutIndex, c: states };
            localStorage.setItem('tempWorkoutState', JSON.stringify(saveObj));
        },

        renderHistoryList: function() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            if(!this.historyData.length) list.innerHTML = '<p class="empty-msg">Hist√≥rico vazio.</p>';
            this.historyData.forEach(h => {
                const uColor = this.data && Object.values(this.data).find(u=>u.name===h.user)?.themeId.includes('1') ? '#38bdf8' : '#fff'; 
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `
                    <div class="hist-top">
                        <div><span class="hist-date">${h.date}</span><span class="hist-user" style="color:${uColor}">${h.user}</span><span>${h.workoutTitle}</span></div>
                        <div style="text-align:right"><button style="background:none;border:none;margin-top:5px" onclick="window.app.delHist(${h.id}, '${h.firebaseId||''}')">üóëÔ∏è</button></div>
                    </div>
                    <div class="hist-loc">üìç ${h.location}</div>
                    ${h.skipped && h.skipped.length ? `<div class="skipped-list">‚ö†Ô∏è Pulou: ${h.skipped.join(', ')}</div>` : ''}
                `;
                list.appendChild(div);
            });
        },

        toggleMenuEdit: function() { this.isMenuEditing = !this.isMenuEditing; this.renderMenu(); },
        toggleSelectEditMode: function() { this.isSelectEditing = !this.isSelectEditing; this.renderWorkoutSelectScreen(); },
        toggleActiveEditMode: function() { this.isActiveEditing = !this.isActiveEditing; this.renderActiveWorkout(); },
        
        renameUser: function(id, val) { if(val) { this.data[id].name = val; this.save(); } },
        renameWorkout: function(idx, prefix, val) { if(val) { this.data[this.currentUser].workouts[idx].title = prefix + val; this.save(); } },
        renameEx: function(i, val) { if(val) { this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises[i].name = val; this.save(); } },
        updateExMeta: function(i, field, val) { if(val) { this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises[i][field] = val; this.save(); } },
        
        deleteUser: function(e, id) { e.stopPropagation(); if(confirm('Apagar usu√°rio?')) { delete this.data[id]; this.save(); } },
        deleteWorkout: function(e, idx) { e.stopPropagation(); if(confirm('Apagar treino?')) { this.data[this.currentUser].workouts.splice(idx, 1); this.save(); } },
        deleteEx: function(i) { if(confirm('Apagar?')) { this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises.splice(i,1); this.save(); this.renderActiveWorkout(); } },
        
        // CORRE√á√ÉO: Reordena√ß√£o de S√©ries com Renomea√ß√£o Autom√°tica (A/B/C)
        reorderUser: function(cid, d) {
            const e = Object.entries(this.data); const i = e.findIndex(([k])=>k===cid);
            if((d===-1&&i===0)||(d===1&&i===e.length-1)) return;
            const t=e[i]; e[i]=e[i+d]; e[i+d]=t; this.data={}; e.forEach(([k,v])=>this.data[k]=v); this.save(); this.renderMenu();
        },
        reorderEx: function(i, d) {
            const e = this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises;
            if((d===-1&&i===0)||(d===1&&i===e.length-1)) return;
            [e[i], e[i+d]] = [e[i+d], e[i]]; this.save(); this.renderActiveWorkout();
        },
        reorderWorkout: function(idx, d) {
            const workouts = this.data[this.currentUser].workouts;
            if ((d === -1 && idx === 0) || (d === 1 && idx === workouts.length - 1)) return;
            
            // Troca de posi√ß√£o no array
            [workouts[idx], workouts[idx + d]] = [workouts[idx + d], workouts[idx]];
            
            // Renomeia os prefixos (A, B, C...)
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            workouts.forEach((w, i) => {
                const letter = letters[i] || '?';
                const parts = w.title.split(' - ');
                // Se tiver tra√ßo, preserva o nome, sen√£o usa o titulo todo
                const name = parts.length > 1 ? parts.slice(1).join(' - ') : w.title;
                w.id = letter;
                w.title = `${letter} - ${name}`;
            });
            
            this.save();
            this.renderWorkoutSelectScreen();
        },

        addUser: function() { const n=prompt("Nome:"); if(n) { this.data['u_'+Date.now()]={name:n, themeId:`theme-${Math.floor(Math.random()*6)+1}`, workouts:[]}; this.save(); this.renderMenu(); } },
        addWorkout: function() { const u=this.data[this.currentUser]; const l="ABCDEFGHIJKLMNOPQRSTUVWXYZ"; const id=l[u.workouts?u.workouts.length:0]||'?'; const n=prompt(`Treino ${id}:`); if(n) { if(!u.workouts)u.workouts=[]; u.workouts.push({id:id, title:`${id} - ${n}`, exercises:[]}); this.save(); this.renderWorkoutSelectScreen(); } },
        addExercise: function() { const w=this.data[this.currentUser].workouts[this.currentWorkoutIndex]; const n=prompt("Exerc√≠cio:"); if(n) { if(!w.exercises)w.exercises=[]; w.exercises.push({name:n, sets:"3", reps:"10", weight:0}); this.save(); this.renderActiveWorkout(); setTimeout(()=>window.scrollTo(0,document.body.scrollHeight),100); } },

        chgWeight: function(i, d) { const e=this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises[i]; let w=(parseInt(e.weight)||0)+d; if(w<0)w=0; e.weight=w; this.save(); this.renderActiveWorkout(); },
        promptWeight: function(i) { const e=this.data[this.currentUser].workouts[this.currentWorkoutIndex].exercises[i]; const v=prompt("Carga (kg):", e.weight||0); if(v!==null) { e.weight=parseInt(v)||0; this.save(); this.renderActiveWorkout(); } },

        finishWorkout: function() {
            const chks = document.querySelectorAll('.ex-check'); let p = false;
            for(let c of chks) if(!c.checked) p = true;
            
            if(p) {
                const msg = incompleteMessages[Math.floor(Math.random()*incompleteMessages.length)];
                this.showCustomModal('warning', `üëÄ ${msg}\n\nFinalizar incompleto?`, () => this.processFinish(true));
            } else {
                this.processFinish(false);
            }
        },

        processFinish: function(incomplete) {
            const btn = document.getElementById('btn-finish-main'); btn.innerText = "Salvando..."; btn.disabled = true;
            
            const wName = this.data[this.currentUser].workouts[this.currentWorkoutIndex].title;
            this.isTraining = false; 
            window.onbeforeunload = null;
            this.quitAttempts = 0;
            localStorage.removeItem('tempWorkoutState');

            // Simula delay de salvamento para "sentir" o app salvando e evitar erros
            setTimeout(() => {
                this.saveHist(wName, "Local Salvo", false, incomplete ? ["Incompleto"] : []);
            }, 1000);
        },

        saveHist: function(t, l, c, s) {
            const reg = { id: Date.now(), date: new Date().toLocaleDateString('pt-BR'), user: this.data[this.currentUser].name, workoutTitle: t, location: l, cheat: c, skipped: s };
            if(window.dbInstance) window.dbPush(window.dbRef(window.dbInstance, 'history'), reg);
            else { 
                const allHist = JSON.parse(localStorage.getItem('gymHistory')) || [];
                allHist.unshift(reg);
                localStorage.setItem('gymHistory', JSON.stringify(allHist));
                this.historyData = allHist.filter(h => h.user === this.data[this.currentUser].name);
            }
            
            const randomMsg = successMessages[Math.floor(Math.random()*successMessages.length)];
            this.showCustomModal('success', randomMsg, () => this.navigate('screen-menu'));
        },
        
        showHistory: function() { this.navigate('screen-history'); },
        delHist: function(id, fid) { if(confirm('Apagar?')) { if(window.dbInstance&&fid) window.dbRemove(window.dbRef(window.dbInstance, `history/${fid}`)); else { 
             const allHist = JSON.parse(localStorage.getItem('gymHistory')) || [];
             const newHist = allHist.filter(x=>x.id!==id);
             localStorage.setItem('gymHistory', JSON.stringify(newHist));
             this.historyData = newHist.filter(h => h.user === this.data[this.currentUser].name);
             this.renderHistoryList(); 
        } } },
        clearAllHistory: function() { if(confirm('Tudo?')) { if(window.dbInstance) window.dbRemove(window.dbRef(window.dbInstance, 'history')); else { localStorage.removeItem('gymHistory'); this.historyData=[]; this.renderHistoryList(); } } },
        
        goHome: function() { window.history.back(); }, 
        toggleScreen: function(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('visible')); document.getElementById(id).classList.add('visible'); },
        updateEditIcon: function(bid, sid, isE) { const b=document.getElementById(bid); const s=document.getElementById(sid); if(isE) { b.innerText='üíæ'; b.classList.add('icon-active'); s.classList.add('editing'); } else { b.innerText='‚úèÔ∏è'; b.classList.remove('icon-active'); s.classList.remove('editing'); } }
    };

    // Override para adicionar reordena√ß√£o na tela de s√©rie
    window.app.renderWorkoutSelectScreen = function() {
        if(!this.currentUser || !this.data[this.currentUser]) return;
        const u = this.data[this.currentUser];
        document.getElementById('select-user-title').innerText = u.name;
        const list = document.getElementById('workout-select-list'); list.innerHTML = '';
        if(!u.workouts || u.workouts.length === 0) {
            list.innerHTML = `<p class="empty-msg">Nenhum treino cadastrado.<br>Toque na caneta ‚úèÔ∏è para criar.</p>`;
            if(!u.workouts) u.workouts = [];
        }
        u.workouts.forEach((w, idx) => {
            const wrap = document.createElement('div'); wrap.className = 'card-wrapper';
            const card = document.createElement('div');
            card.className = `workout-select-card bd-${u.themeId}`;
            card.style.borderLeft = '5px solid';
            card.onclick = () => this.navigate('screen-active-workout', { userId: this.currentUser, wIndex: idx });
            let titleDisplay = `<h3>${w.title}</h3>`;
            if(this.isSelectEditing) {
                const parts = w.title.split(' - ');
                const prefix = parts.length > 1 ? parts[0] + ' - ' : '';
                const name = parts.length > 1 ? parts.slice(1).join(' - ') : w.title;
                titleDisplay = `<h3>${prefix}<input type="text" class="edit-input" style="width:100%; display:block; margin-top:5px" value="${name}" onclick="event.stopPropagation()" onchange="window.app.renameWorkout(${idx}, '${prefix}', this.value)"></h3>`;
            }
            card.innerHTML = `${titleDisplay}<p>${w.exercises ? w.exercises.length : 0} exerc√≠cios</p>`;
            if(this.isSelectEditing) {
                const ctrl = document.createElement('div'); ctrl.className = 'edit-controls-floating';
                ctrl.innerHTML = `<div class="btn-float btn-del" onclick="window.app.deleteWorkout(event, ${idx})">X</div>
                                  <div class="btn-float btn-reorder" onclick="window.app.reorderWorkout(${idx}, -1)">‚¨ÜÔ∏è</div>
                                  <div class="btn-float btn-reorder" onclick="window.app.reorderWorkout(${idx}, 1)">‚¨áÔ∏è</div>`;
                wrap.appendChild(ctrl);
            }
            wrap.appendChild(card); list.appendChild(wrap);
        });
        this.updateEditIcon('btn-edit-select', 'screen-workout-select', this.isSelectEditing);
    };

    window.onload = function() { if(window.app && window.app.init) window.app.init(); };
    </script>
</body>
</html>
